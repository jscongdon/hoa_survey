services:
  web:
    container_name: hoa_survey_dev
    build: .
    working_dir: /app
    # Install once (if node_modules missing), generate prisma client, sync jwt secret, then run dev
    command: bash -lc "if [ ! -d node_modules ]; then npm ci --legacy-peer-deps; fi && npx prisma generate && npm run dev"
    ports:
      - "3000:3000"
    volumes:
      - ./:/app:cached
      - node_modules:/app/node_modules
      - hoasurvey-data:/data
      - ./public/uploads:/app/public/uploads
    environment:
      DATABASE_URL: "file:/data/hoasurvey.db"
      UPLOADS_DIR: "/app/public/uploads"
      NODE_ENV: development
      CHOKIDAR_USEPOLLING: "true"
      # JWT_SECRET can be provided via .env.local or Docker environment
    restart: unless-stopped
    tty: true

volumes:
  node_modules: {}
  hoasurvey-data:
    external: true
    name: hoasurvey-data
